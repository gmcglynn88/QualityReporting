<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QA Evaluations – Monthly View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{ --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D; --pill:#e9f6f0; }
    body{font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:start}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}
    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}

    table{width:100%;border-collapse:collapse;margin-top:12px;border:1px solid var(--border-color);border-radius:6px;overflow:hidden}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border-color);vertical-align:top}
    th{background-color:var(--primary-color);color:white;font-weight:600}
    tr:hover{background-color:rgba(99,171,143,.05)}
    .table-container{overflow-x:auto;border:1px solid var(--border-color);border-radius:6px;padding:1px;margin-top:10px}

    .tab{display:inline-block;padding:12px 20px;margin-right:10px;background:#eee;cursor:pointer;border-radius:6px;font-weight:500}
    .tab.active{background:var(--primary-color);color:white}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;border:1px solid var(--border-color);background:#fff}
    .badge-critical{color:#b4231a;border-color:#fecaca;background:#fee2e2}
    .badge-fatal{color:#fff;background:#b4231a;border-color:#b4231a}
    .badge-ok{color:#14532d;background:#dcfce7;border-color:#bbf7d0}
    details.evaluation{border:1px solid var(--border-color);border-radius:8px;padding:10px;margin:10px 0;background:#fff}
    details.evaluation summary{cursor:pointer;font-weight:600}

    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
    .kpi{background:#fff;border:1px solid var(--border-color);border-radius:8px;padding:12px}
    .kpi .label{color:var(--text-light);font-size:12px}
    .kpi .value{font-size:20px;font-weight:700;margin-top:4px}

    .checkbox-dropdown{position:relative;min-width:220px;width:100%}
    .cd-trigger{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border-color);border-radius:6px;background:#fff;padding:10px;cursor:pointer;width:100%;box-sizing:border-box}
    .cd-trigger .label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .cd-trigger .count{background:var(--pill);border:1px solid var(--border-color);border-radius:999px;padding:2px 8px;font-size:12px;color:#2c3e50;flex-shrink:0;margin-left:8px}
    .cd-panel{position:absolute;z-index:1000;margin-top:6px;background:#fff;border:1px solid var(--border-color);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;max-height:340px;overflow:hidden;display:none;box-sizing:border-box}
    .cd-panel.open{display:block}
    .cd-header{padding:10px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center}
    .cd-search{flex:1;border:1px solid var(--border-color);border-radius:6px;padding:8px;width:100%;box-sizing:border-box}
    .cd-actions{display:flex;gap:8px}
    .cd-actions button{background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);border-radius:6px;padding:8px 10px;cursor:pointer;white-space:nowrap}
    .cd-selectall{padding:8px 12px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:10px}
    .cd-list{max-height:260px;overflow:auto}
    .cd-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #f1f3f5}
    .cd-item label{display:flex;align-items:center;gap:10px;cursor:pointer;width:100%}
    .cd-footer{padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);font-size:12px;color:#6c757d;display:flex;justify-content:space-between}

    .loading-spinner{display:inline-block;width:20px;height:20px;border:2px solid #f3f3f3;border-top:2px solid var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    .comment-bubble{background:#f8f9fa;border:1px solid #dee2e6;border-radius:12px;padding:8px 12px;margin-top:4px;font-size:12px;color:#6c757d}
    tr.critical-warning{background-color:#fffbeb!important;border-left:4px solid #f59e0b}
    tr.fatal-question{background-color:#fef2f2!important;border-left:4px solid #dc2626}
    tr.critical-warning:hover{background-color:#fef3c7!important}
    tr.fatal-question:hover{background-color:#fecaca!important}
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo">
  </div>

  <h1>QA Evaluations – Monthly View</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <div id="authDebug" class="card" style="display:none">
    <h2 class="section-title">Auth debug</h2>
    <pre id="authDump" style="background:#f6f8fa;border:1px solid #eee;padding:12px;border-radius:8px;overflow:auto"></pre>
    <button id="signinBtn">Sign in with Genesys</button>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">Configuration</h2>
      <div class="controls">
        <div>
          <label for="userDropdown">Agents (Optional)</label>
          <div id="userDropdown" class="checkbox-dropdown"></div>
          <div class="muted">Select agents to filter by, or leave empty for all</div>
        </div>
        <div>
          <label for="formDropdown">Evaluation Forms (Optional)</label>
          <div id="formDropdown" class="checkbox-dropdown"></div>
          <div class="muted">Select forms to filter by, or leave empty for all</div>
        </div>
        <div>
          <label for="monthInput">Month</label>
          <input id="monthInput" type="month">
          <div class="muted">Evaluations within the selected month</div>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="loadBtn" class="full-width-btn" disabled>
            <span class="loading-spinner" style="display:none"></span>
            <span class="btn-text">Load Evaluations</span>
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="margin-bottom:10px;">
        <div id="tabs">
          <div id="overviewTabButton" class="tab active">Overview</div>
          <div id="trendsTabButton" class="tab">Agent Trends</div>
          <div id="detailsTabButton" class="tab">Evaluation Details</div>
          <div id="criticalTabButton" class="tab">Critical / Fatal Summary</div>
        </div>
      </div>

      <div id="overviewTab" class="tab-content active">
        <h2 class="section-title">Monthly Overview</h2>
        <div id="overviewKPIs" class="kpis"></div>
        <div class="table-container">
          <table id="agentSummaryTable"></table>
        </div>
      </div>

      <div id="trendsTab" class="tab-content">
        <h2 class="section-title">Daily Trend by Agent</h2>
        <div class="table-container">
          <table id="trendTable"></table>
        </div>
      </div>

      <div id="detailsTab" class="tab-content">
        <h2 class="section-title">Evaluation Details (with Question Scores)</h2>
        <div id="detailsContainer"></div>
      </div>

      <div id="criticalTab" class="tab-content">
        <h2 class="section-title">Critical / Kill Question Counts</h2>
        <div class="table-container">
          <table id="criticalTable"></table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== OAuth Configuration =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const config = { REGION: 'mypurecloud.ie' };
    const DEBUG = new URLSearchParams(window.location.search).has('debug');
    const redirectUri = 'https://gmcglynn88.github.io/QualityReporting/';
    const oauthUrl = `https://login.${config.REGION}/oauth/authorize?client_id=${encodeURIComponent(clientId)}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&state=qa`;

    const state = {
      accessToken: null,
      users: [],
      forms: [],
      formsById: {},
      evals: [],
      monthStart: null,
      monthEnd: null,
      // caches keyed by "formId@version" or "pub@publishedFormId"
      formDetailsCache: new Map(),
      formLookupCache: new Map(),
      // merged lookup per evaluation-form combo
      combinedLookupCache: new Map()
    };

    const dropdowns = { users:null, forms:null };
    let lastApiCall = 0;
    const API_DELAY = 100;

    function msg(html,type='info'){
      const box=document.getElementById('messageContainer');
      box.innerHTML=`<div class="${type}-message">${html}</div>`;
      box.style.display='block';
      if(type==='success'){ setTimeout(()=>box.style.display='none',5000); }
    }

    function setLoading(button,isLoading){
      const spinner=button.querySelector('.loading-spinner');
      const text=button.querySelector('.btn-text');
      if(isLoading){ spinner.style.display='inline-block'; text.textContent='Loading...'; button.disabled=true; }
      else{ spinner.style.display='none'; text.textContent='Load Evaluations'; button.disabled=false; }
    }

    // ===== Checkbox dropdown =====
    function createCheckboxDropdown(containerId,{placeholder,searchPlaceholder}){
      const root=document.getElementById(containerId); root.innerHTML='';
      const trigger=document.createElement('div'); trigger.className='cd-trigger';
      trigger.innerHTML=`<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);
      const panel=document.createElement('div'); panel.className='cd-panel';
      panel.innerHTML=`
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions"><button type="button" data-cd="clear">Clear</button></div>
        </div>
        <div class="cd-selectall"><label><input type="checkbox" data-cd="selectall"/> Select all</label></div>
        <div class="cd-list"></div>
        <div class="cd-footer"><span data-cd="summary">0 selected</span><span>Click outside to close</span></div>`;
      root.appendChild(panel);

      const list=panel.querySelector('.cd-list');
      const search=panel.querySelector('.cd-search');
      const clearBtn=panel.querySelector('[data-cd="clear"]');
      const selectAll=panel.querySelector('[data-cd="selectall"]');
      const summary=panel.querySelector('[data-cd="summary"]');

      let options=[]; let selected=new Set();

      function render(filter=''){
        const ft=filter.trim().toLowerCase(); list.innerHTML='';
        const filtered=!ft?options:options.filter(o=>(o.label||'').toLowerCase().includes(ft));
        if(!filtered.length){ list.innerHTML=`<div class="cd-item" style="color:#6C757D">No matches</div>`; return; }
        filtered.forEach(o=>{
          const id=`${containerId}__${o.value}`;
          const row=document.createElement('div'); row.className='cd-item';
          row.innerHTML=`<label for="${id}"><input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value)?'checked':''}/><span>${o.label||o.value}</span></label>`;
          row.querySelector('input').addEventListener('change',(e)=>{ if(e.target.checked) selected.add(o.value); else selected.delete(o.value); updateSummary(); updateSelectAllState(); updateLoadButtonState(); });
          list.appendChild(row);
        });
      }
      function updateSummary(){ trigger.querySelector('.count').textContent=`${selected.size} selected`; summary.textContent=`${selected.size} selected`; }
      function updateSelectAllState(){ const total=options.length,count=selected.size; selectAll.indeterminate=count>0&&count<total; selectAll.checked=total>0&&count===total; }

      trigger.addEventListener('click',()=>{ panel.classList.toggle('open'); search.focus(); });
      document.addEventListener('click',(e)=>{ if(!root.contains(e.target)) panel.classList.remove('open'); });
      search.addEventListener('input',()=>render(search.value));
      clearBtn.addEventListener('click',()=>{ selected.clear(); render(search.value); updateSummary(); updateSelectAllState(); updateLoadButtonState(); });
      selectAll.addEventListener('change',()=>{ if(selectAll.checked) options.forEach(o=>selected.add(o.value)); else selected.clear(); render(search.value); updateSummary(); updateLoadButtonState(); });

      function setOptions(newOptions){ options=newOptions||[]; selected.forEach(v=>{ if(!options.some(o=>o.value===v)) selected.delete(v); }); render(search.value); updateSummary(); updateSelectAllState(); updateLoadButtonState(); }
      function getSelectedValues(){ return Array.from(selected); }

      render(''); return { setOptions, getSelectedValues };
    }

    function updateLoadButtonState(){
      const hasMonth=document.getElementById('monthInput').value;
      const hasUsers=dropdowns.users && dropdowns.users.getSelectedValues().length>0;
      const hasForms=dropdowns.forms && dropdowns.forms.getSelectedValues().length>0;
      document.getElementById('loadBtn').disabled=!(hasMonth && (hasUsers||hasForms));
    }

    // ===== Bootstrapping =====
    document.addEventListener('DOMContentLoaded',()=>{
      const params=new URLSearchParams(window.location.hash.substring(1));
      const tokenFromHash=params.get('access_token');
      if(tokenFromHash){ sessionStorage.setItem('purecloud_token',tokenFromHash); history.replaceState(null,document.title,window.location.pathname+window.location.search); startApp(tokenFromHash); return; }
      const tokenFromSession=sessionStorage.getItem('purecloud_token');
      if(tokenFromSession){ startApp(tokenFromSession); return; }
      if(DEBUG){
        document.getElementById('authDebug').style.display='block';
        document.getElementById('authDump').textContent='No token. Click Sign in.';
        document.getElementById('signinBtn').onclick=()=>window.location.href=oauthUrl;
        document.getElementById('auth-message').textContent='Debug mode: click Sign in with Genesys';
      } else {
        document.getElementById('auth-message').textContent='Redirecting to Genesys Cloud for authentication...';
        setTimeout(()=>{ window.location.href=oauthUrl; }, 1200);
      }
    });

    function startApp(token){
      state.accessToken=token;
      document.getElementById('auth-message').textContent='Authenticated successfully!';
      document.getElementById('auth-message').className='success-message';
      setTimeout(()=>{ document.getElementById('authCard').style.display='none'; document.getElementById('authDebug').style.display='none'; }, 800);
      document.getElementById('appContent').style.display='block';

      dropdowns.users=createCheckboxDropdown('userDropdown',{placeholder:'Select agents (optional)',searchPlaceholder:'Search agents...'});
      dropdowns.forms=createCheckboxDropdown('formDropdown',{placeholder:'Select forms (optional)',searchPlaceholder:'Search forms...'});

      document.getElementById('overviewTabButton').onclick=()=>setTab('overview');
      document.getElementById('trendsTabButton').onclick=()=>setTab('trends');
      document.getElementById('detailsTabButton').onclick=()=>setTab('details');
      document.getElementById('criticalTabButton').onclick=()=>setTab('critical');
      document.getElementById('loadBtn').onclick=loadEvaluations;

      const m=new Date(); document.getElementById('monthInput').value=`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}`;
      updateMonthRange(); document.getElementById('monthInput').addEventListener('change',()=>{ updateMonthRange(); updateLoadButtonState(); });

      Promise.all([fetchAllUsers(),fetchAllForms()]).then(updateLoadButtonState).catch(e=>msg('Initial load failed: '+e.message,'error'));
    }

    function setTab(name){ ['overview','trends','details','critical'].forEach(n=>{ document.getElementById(`${n}Tab`).classList.toggle('active',n===name); document.getElementById(`${n}TabButton`).classList.toggle('active',n===name); }); }
    function updateMonthRange(){ const val=document.getElementById('monthInput').value; if(!val) return; const [y,m]=val.split('-').map(Number); state.monthStart=new Date(Date.UTC(y,m-1,1,0,0,0)); state.monthEnd=new Date(Date.UTC(y,m,0,23,59,59)); }

    // ===== API helpers =====
    async function rateLimitedFetch(url,options={}){
      const now=Date.now(); const delta=now-lastApiCall;
      if(delta<API_DELAY) await new Promise(r=>setTimeout(r,API_DELAY-delta));
      lastApiCall=Date.now();
      return fetch(url,{...options,headers:{'Authorization':'Bearer '+state.accessToken,'Content-Type':'application/json',...options.headers}});
    }
    async function fetchPaginatedGET(url){
      let all=[]; let next=url;
      while(next){
        const res=await rateLimitedFetch(next);
        if(!res.ok) throw new Error(`HTTP ${res.status} for ${next}`);
        const data=await res.json();
        if(Array.isArray(data.entities)) all=all.concat(data.entities);
        else if(Array.isArray(data.users)) all=all.concat(data.users);
        else if(Array.isArray(data)) all=all.concat(data);
        else if(data.entities) all=all.concat(data.entities);
        next=data.nextUri?`https://api.${config.REGION}${data.nextUri}`:null;
      }
      return all;
    }
    function safeGet(o,p,def=null){ try{ return p.split('.').reduce((x,k)=>(x && k in x)?x[k]:undefined ,o) ?? def; }catch{ return def; } }
    function pct(n,d=1){ if(n==null||!isFinite(n)) return '-'; return (Math.round(n*10**d)/10**d).toFixed(d)+'%'; }
    function fmt(n,d=1){ if(n==null||!isFinite(n)) return '-'; return (Math.round(n*10**d)/10**d).toFixed(d); }
    function toUKDate(d){ const dt=new Date(d); return dt.toLocaleDateString('en-GB'); }
    function dayKeyUTC(d){ const dt=new Date(d); return new Date(Date.UTC(dt.getUTCFullYear(),dt.getUTCMonth(),dt.getUTCDate())).toISOString().split('T')[0]; }

    // ===== Lookups =====
    async function fetchAllUsers(){
      const url=`https://api.${config.REGION}/api/v2/users?pageSize=100`;
      const users=await fetchPaginatedGET(url);
      state.users=users.map(u=>({id:u.id,name:(u.name || `${u.givenName||''} ${u.familyName||''}`).trim(),email:u.email||''})).sort((a,b)=>a.name.localeCompare(b.name));
      dropdowns.users.setOptions(state.users.map(u=>({value:u.id,label:`${u.name}${u.email?` — ${u.email}`:''}`})));
    }
    async function fetchAllForms(){
      const url=`https://api.${config.REGION}/api/v2/quality/forms/evaluations?pageSize=100`;
      const forms=await fetchPaginatedGET(url);
      state.forms=forms.map(f=>({id:f.id,name:f.name||f.title||'(Unnamed form)'})).sort((a,b)=>a.name.localeCompare(b.name));
      state.formsById=Object.fromEntries(state.forms.map(f=>[f.id,f]));
      dropdowns.forms.setOptions(state.forms.map(f=>({value:f.id,label:f.name})));
    }

    // ===== Evaluations =====
    async function loadEvaluations(){
      const agentIds=dropdowns.users.getSelectedValues();
      const formIds=dropdowns.forms.getSelectedValues();
      if(agentIds.length===0 && formIds.length===0){ msg('Please select at least one agent or form.','error'); return; }
      if(!state.monthStart || !state.monthEnd){ msg('Please select a month.','error'); return; }

      const btn=document.getElementById('loadBtn'); setLoading(btn,true); msg('Loading evaluations…','info');
      try{
        state.evals=await fetchDetailedEvaluations(agentIds,formIds);
        msg(`Loaded ${state.evals.length} evaluations.`,'success');
        renderAll();
      }catch(e){ console.error(e); msg('Failed to load evaluations: '+e.message,'error'); }
      finally{ setLoading(btn,false); }
    }

    async function fetchDetailedEvaluations(agentIds,formIds){
      const all=[]; let agentsToQuery=agentIds;
      if(agentIds.length===0 && formIds.length>0) agentsToQuery=state.users.map(u=>u.id);
      const batchSize=5;
      for(let i=0;i<agentsToQuery.length;i+=batchSize){
        const batch=agentsToQuery.slice(i,i+batchSize);
        const res=await Promise.all(batch.map(id=>fetchEvaluationsForAgent(id,formIds)));
        res.forEach(items=>all.push(...items));
        if(i+batchSize<agentsToQuery.length) await new Promise(r=>setTimeout(r,200));
      }
      return all;
    }

    async function fetchEvaluationsForAgent(agentId,formIds){
      const start=state.monthStart.toISOString(); const end=state.monthEnd.toISOString();
      const base=`https://api.${config.REGION}/api/v2/quality/evaluations/query`;
      const params=new URLSearchParams({agentUserId:agentId,startTime:start,endTime:end,expandAnswerTotalScores:'true',pageSize:'50'});
      if(formIds && formIds.length===1) params.set('formId',formIds[0]);

      let all=[]; let next=`${base}?${params.toString()}`;
      while(next){
        const res=await rateLimitedFetch(next);
        if(!res.ok){
          if(res.status===400 || res.status===405) return fetchEvaluationsViaPOST(agentId,formIds);
          throw new Error(`Failed to fetch evaluations: ${res.status}`);
        }
        const data=await res.json();
        all=all.concat(data.entities||[]);
        next=data.nextUri?`https://api.${config.REGION}${data.nextUri}`:null;
      }
      return all;
    }

    async function fetchEvaluationsViaPOST(agentId,formIds){
      const start=state.monthStart.toISOString(); const end=state.monthEnd.toISOString();
      const body={agentUserIds:[agentId],interval:`${start}/${end}`,expandAnswerTotalScores:true,pageSize:50};
      if(formIds && formIds.length>0) body.formIds=formIds;
      const url=`https://api.${config.REGION}/api/v2/quality/evaluations/query`;
      let all=[]; let page=1;
      while(true){
        body.pageNumber=page;
        const res=await rateLimitedFetch(url,{method:'POST',body:JSON.stringify(body)});
        if(!res.ok) throw new Error(`POST method failed: ${res.status}`);
        const data=await res.json(); const items=data.entities||[];
        if(items.length===0) break; all=all.concat(items);
        if(!data.nextUri && items.length<body.pageSize) break; page++;
      }
      return all;
    }

    // ===== Form fetching (design version, latest, and published) =====
    function formKey(formId, versionId){
      return (versionId === '__published__') ? `pub@${formId}` : `${formId}@${versionId || 'latest'}`;
    }

    async function getFormDetails(formId, versionId){
      const key=formKey(formId,versionId);
      if(state.formDetailsCache.has(key)) return state.formDetailsCache.get(key);

      let url;
      if (versionId === '__published__') {
        url = `https://api.${config.REGION}/api/v2/quality/publishedforms/evaluations/${formId}`;
      } else {
        url = versionId
          ? `https://api.${config.REGION}/api/v2/quality/forms/evaluations/${formId}/versions/${versionId}`
          : `https://api.${config.REGION}/api/v2/quality/forms/evaluations/${formId}`;
      }

      try{
        let res=await rateLimitedFetch(url);
        if(!res.ok && versionId && versionId !== '__published__'){
          // fallback to latest
          res=await rateLimitedFetch(`https://api.${config.REGION}/api/v2/quality/forms/evaluations/${formId}`);
        }
        if(!res.ok){ state.formDetailsCache.set(key,null); return null; }
        const json=await res.json();
        state.formDetailsCache.set(key,json);
        state.formLookupCache.set(key,buildFormLookup(json||{}));
        return json;
      }catch(e){
        console.warn('Form details fetch error:',e);
        state.formDetailsCache.set(key,null);
        return null;
      }
    }

    function buildFormLookup(form){
      const questionText=new Map(); // id/contextId/questionId/questionContextId -> text
      const answerText=new Map();   // id/contextId/answerId/answerOptionId     -> text
      const questionObj=new Map();  // ids -> question object

      function addQ(q){
        if(!q) return;
        const qTxt=q.text || q.label || q.title || '';
        [q.id,q.contextId,q.questionId,q.questionContextId].filter(Boolean).forEach(id=>{
          questionText.set(id,qTxt);
          questionObj.set(id,q);
        });
        (q.answerOptions||[]).forEach(a=>{
          const aTxt=a.text ?? String(a.value ?? '');
          [a.id,a.contextId,a.answerId,a.answerOptionId].filter(Boolean).forEach(id=>{
            answerText.set(id,aTxt);
          });
        });
        (q.multipleSelectOptionQuestions||[]).forEach(addQ);
      }
      function walkGroups(groups){
        (groups||[]).forEach(g=>{
          (g.questions||[]).forEach(addQ);
          (g.questionGroups||[]).forEach(walkGroups);
        });
      }
      (form?.questions||[]).forEach(addQ);
      walkGroups(form?.questionGroups);
      return {questionText, answerText, questionObj};
    }

    // Build a *merged* lookup for the exact evaluation (published + any design form/version)
    async function getCombinedLookupForEval(e){
      const pubId = safeGet(e,'evaluationForm.id');
      const formId = safeGet(e,'form.id') || e.formId;
      const formVersionId = safeGet(e,'form.versionId') || e.formVersionId || safeGet(e,'form.version');

      const comboKey = [
        pubId ? `pub:${pubId}` : '',
        formId ? `form:${formId}` : '',
        formVersionId ? `ver:${formVersionId}` : ''
      ].filter(Boolean).join('|') || 'none';

      if(state.combinedLookupCache.has(comboKey)) return state.combinedLookupCache.get(comboKey);

      // Fetch what we can
      const detailPromises = [];
      if(pubId) detailPromises.push(getFormDetails(pubId,'__published__'));
      if(formId && formVersionId) detailPromises.push(getFormDetails(formId,formVersionId));
      if(formId && !formVersionId) detailPromises.push(getFormDetails(formId,null));
      const details = (await Promise.all(detailPromises)).filter(Boolean);

      // Merge the lookups
      const merged = { questionText:new Map(), answerText:new Map(), questionObj:new Map() };
      const names = [];

      details.forEach(d=>{
        if(d?.name) names.push(d.name);
        const lk = buildFormLookup(d||{});
        lk.questionText.forEach((v,k)=>merged.questionText.set(k,v));
        lk.answerText.forEach((v,k)=>merged.answerText.set(k,v));
        lk.questionObj.forEach((v,k)=>merged.questionObj.set(k,v));
      });

      const formName =
        safeGet(e,'evaluationForm.name') ||
        safeGet(e,'form.name') ||
        names[0] || '(Form)';

      const combined = { ...merged, formName };
      state.combinedLookupCache.set(comboKey, combined);
      return combined;
    }

    // ===== Resolution helpers =====
    function approx(a,b){ return Math.abs(Number(a)-Number(b)) < 1e-6; }

    function collectAnswerIds(qScore){
      const ids=new Set();
      (qScore.selectedAnswerIds||[]).forEach(x=>ids.add(x));
      (qScore.selectedAnswerOptionIds||[]).forEach(x=>ids.add(x));
      if(qScore.selectedAnswerId) ids.add(qScore.selectedAnswerId);
      if(qScore.answerOptionId) ids.add(qScore.answerOptionId);
      if(qScore.answerId) ids.add(qScore.answerId);
      const a=qScore.answer||{};
      [a.id,a.contextId,a.answerId,a.answerOptionId].filter(Boolean).forEach(x=>ids.add(x));
      (qScore.answers||[]).forEach(ans=>{ [ans.id,ans.contextId,ans.answerId,ans.answerOptionId].filter(Boolean).forEach(x=>ids.add(x)); });
      return Array.from(ids);
    }

    function resolveQuestionTextWithLookup(lookup,qScore){
      const candidates=[qScore.questionId,qScore.questionContextId,safeGet(qScore,'question.id'),safeGet(qScore,'question.contextId')].filter(Boolean);
      for(const id of candidates){ const t=lookup.questionText.get(id); if(t) return t; }
      return safeGet(qScore,'question.text') || `Question ${candidates[0]||''}`.trim();
    }

    function resolveAnswerTextWithLookup(lookup,qScore){
      // 1) by id/contextId
      const ids=collectAnswerIds(qScore);
      if(ids.length){
        const texts=[];
        ids.forEach(id=>{ const t=lookup.answerText.get(id); if(t) texts.push(t); });
        if(texts.length) return texts.join(', ');
      }
      // 2) by score → option.value
      const qIds=[qScore.questionId,qScore.questionContextId,safeGet(qScore,'question.id'),safeGet(qScore,'question.contextId')].filter(Boolean);
      const q = qIds.map(id=>lookup.questionObj.get(id)).find(Boolean);
      if(q && Array.isArray(q.answerOptions) && q.answerOptions.length){
        const s = Number(qScore.score);
        const match = q.answerOptions.find(o => approx(s,o.value) || approx(s/100,o.value) || approx(s,o.value*100));
        if(match){ return match.text ?? String(match.value ?? ''); }
      }
      // 3) other fields
      if(qScore.freeTextAnswer) return String(qScore.freeTextAnswer);
      if(qScore.numericAnswer!==undefined && qScore.numericAnswer!==null) return String(qScore.numericAnswer);
      if(safeGet(qScore,'answer.text')) return qScore.answer.text;
      return 'N/A';
    }

    // ===== Renderers =====
    function renderAll(){ renderOverview(); renderTrends(); renderDetails(); renderCritical(); }
    function resolveUserName(id){ const u=state.users.find(x=>x.id===id); return u?u.name:(id||'(unknown)'); }
    function resolveForm(formId){ return state.formsById[formId]; }
    function getEvalPercent(e){
      const p=e.totalScore || e.totalPercent || safeGet(e,'scoring.totalPercent') || safeGet(e,'oTotalPercent') || safeGet(e,'answers.totalScore');
      if(p==null) return null; return p<=1 ? p*100 : p;
    }

    function renderOverview(){
      const evals=state.evals;
      const byAgent=new Map();
      evals.forEach(e=>{
        const a=safeGet(e,'agent.id') || e.agentUserId || e.userId || '(unknown)';
        const p=getEvalPercent(e);
        if(!byAgent.has(a)) byAgent.set(a,{count:0,sum:0});
        const o=byAgent.get(a); o.count++; if(p!=null && isFinite(p)) o.sum+=Number(p);
      });
      const rows=[]; let total=0;
      for(const [aid,{count,sum}] of byAgent.entries()){ rows.push({agent:resolveUserName(aid),count,avg:count?(sum/count):null}); total+=count; }
      rows.sort((a,b)=>a.agent.localeCompare(b.agent));
      const overallAvg=(rows.length && total)?(rows.reduce((s,r)=>s+(r.avg||0),0)/rows.length):null;

      document.getElementById('overviewKPIs').innerHTML=`
        <div class="kpi"><div class="label">Month</div><div class="value">${document.getElementById('monthInput').value}</div></div>
        <div class="kpi"><div class="label">Evaluations</div><div class="value">${evals.length}</div></div>
        <div class="kpi"><div class="label">Agents</div><div class="value">${rows.length}</div></div>
        <div class="kpi"><div class="label">Average Score (Agent Avg)</div><div class="value">${overallAvg==null?'-':pct(overallAvg,1)}</div></div>`;
      const tbl=document.getElementById('agentSummaryTable');
      tbl.innerHTML = rows.length
        ? `<thead><tr><th>Agent</th><th>Evaluations</th><th>Average Score</th></tr></thead>
           <tbody>${rows.map(r=>`<tr><td>${r.agent}</td><td>${r.count}</td><td>${r.avg==null?'-':pct(r.avg,1)}</td></tr>`).join('')}</tbody>`
        : '<tr><td colspan="3" class="muted">No evaluation data available for the selected criteria.</td></tr>';
    }

    function renderTrends(){
      const evals=state.evals;
      const agents=Array.from(new Set(evals.map(e=>safeGet(e,'agent.id')||e.agentUserId))).filter(Boolean);
      const days=[]; for(let d=new Date(state.monthStart); d<=state.monthEnd; d.setUTCDate(d.getUTCDate()+1)){ days.push(new Date(d).toISOString().split('T')[0]); }
      const map=new Map();
      evals.forEach(e=>{
        const aid=safeGet(e,'agent.id')||e.agentUserId||'(unknown)';
        const day=dayKeyUTC(e.releaseDate || e.assignedDate || e.creationDate || e.evaluationDate || e.date || Date.now());
        const p=getEvalPercent(e);
        if(!map.has(aid)) map.set(aid,new Map());
        const dm=map.get(aid);
        if(!dm.has(day)) dm.set(day,{sum:0,count:0});
        if(p!=null && isFinite(p)){ const o=dm.get(day); o.sum+=Number(p); o.count++; }
      });
      const header=`<thead><tr><th>Agent</th>${days.map(k=>`<th>${toUKDate(k)}</th>`).join('')}</tr></thead>`;
      const rows=agents.map(aid=>{
        const dm=map.get(aid)||new Map();
        const cells=days.map(k=>{ const v=dm.get(k); if(!v||v.count===0) return '<td>-</td>'; return `<td>${pct(v.sum/v.count,1)}</td>`; }).join('');
        return `<tr><td>${resolveUserName(aid)}</td>${cells}</tr>`;
      }).join('');
      document.getElementById('trendTable').innerHTML=header+`<tbody>${rows}</tbody>`;
    }

    async function renderDetails(){
      const c=document.getElementById('detailsContainer');
      if(!state.evals.length){ c.innerHTML='<div class="muted">No evaluations loaded.</div>'; return; }
      c.innerHTML='<div class="info-message">Loading evaluation details...</div>';

      const blocks = await Promise.all(state.evals.map(async e=>{
        const lookup = await getCombinedLookupForEval(e);
        const agent=resolveUserName(safeGet(e,'agent.id')||e.agentUserId);
        const when=toUKDate(e.releaseDate || e.assignedDate || e.creationDate || e.evaluationDate || e.date || Date.now());
        const convo=e.conversationId || e.conversation?.id || '(n/a)';
        const score=getEvalPercent(e);
        const qGroups = safeGet(e,'answers.questionGroupScores') || [];

        let qRows='';
        qGroups.forEach(g=>{
          (g.questionScores||[]).forEach(qScore=>{
            const qText=resolveQuestionTextWithLookup(lookup,qScore);
            const aText=resolveAnswerTextWithLookup(lookup,qScore);
            const ansScore=qScore.score ?? null;
            const isFat=!!qScore.failedKillQuestion;
            const isCrit=!!qScore.failedCriticalQuestion;

            let rowClass=''; if(isFat) rowClass='fatal-question'; else if(isCrit) rowClass='critical-warning';
            let comments='';
            if(qScore.comments){ comments+=`<div class="comment-bubble"><strong>Evaluator Comments:</strong> ${qScore.comments}</div>`; }
            if(qScore.aiAnswer && qScore.aiAnswer.explanation){ comments+=`<div class="comment-bubble"><strong>AI Analysis:</strong> ${qScore.aiAnswer.explanation}</div>`; }

            qRows+=`<tr class="${rowClass}">
              <td>${qText}</td>
              <td>${aText}</td>
              <td>${ansScore===null?'-':fmt(ansScore,1)}</td>
              <td>${isFat?'<span class="badge badge-fatal">Fatal</span>':isCrit?'<span class="badge badge-critical">Critical</span>':'<span class="badge badge-ok">OK</span>'}</td>
              <td>${comments}</td>
            </tr>`;
          });
        });

        return `
          <details class="evaluation">
            <summary>${when} • <strong>${agent}</strong> — ${lookup.formName} &nbsp;&middot;&nbsp; Score: <strong>${score==null?'-':pct(score,1)}</strong> ${convo!=='(n/a)'?`&nbsp;&middot;&nbsp; Conversation: ${convo}`:''}</summary>
            <div class="table-container">
              <table>
                <thead><tr><th>Question</th><th>Answer</th><th>Score</th><th>Flags</th><th>Comments</th></tr></thead>
                <tbody>${qRows || `<tr><td colspan="5" class="muted">No question data available.</td></tr>`}</tbody>
              </table>
            </div>
          </details>
        `;
      }));

      c.innerHTML = blocks.join('');
    }

    async function renderCritical(){
      const rows = await Promise.all(state.evals.map(async e=>{
        const lookup = await getCombinedLookupForEval(e);
        const out=[];
        const qGroups=safeGet(e,'answers.questionGroupScores')||[];
        qGroups.forEach(g=>{
          (g.questionScores||[]).forEach(qScore=>{
            if(qScore.failedKillQuestion || qScore.failedCriticalQuestion){
              out.push({
                formName: lookup.formName,
                qText: resolveQuestionTextWithLookup(lookup,qScore),
                fatal: qScore.failedKillQuestion?1:0,
                critical: qScore.failedCriticalQuestion?1:0
              });
            }
          });
        });
        return out;
      }));

      const flat=rows.flat();
      const map=new Map();
      flat.forEach(r=>{
        const key=r.formName+'|'+r.qText;
        if(!map.has(key)) map.set(key,{formName:r.formName,qText:r.qText,critical:0,fatal:0});
        const o=map.get(key); o.critical+=r.critical; o.fatal+=r.fatal;
      });

      const body = Array.from(map.values())
        .sort((a,b)=>(b.fatal+b.critical)-(a.fatal+a.critical))
        .map(r=>`<tr><td>${r.formName}</td><td>${r.qText}</td><td>${r.critical}</td><td>${r.fatal}</td><td>${r.critical+r.fatal}</td></tr>`)
        .join('');

      document.getElementById('criticalTable').innerHTML=`
        <thead><tr><th>Form</th><th>Question</th><th>Critical</th><th>Fatal/Kill</th><th>Total</th></tr></thead>
        <tbody>${body || `<tr><td colspan="5" class="muted">No critical/fatal marks found for the selected period.</td></tr>`}</tbody>`;
    }
  </script>
</body>
</html>
