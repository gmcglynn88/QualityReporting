<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QA Evaluations – Monthly View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    /* ... your existing CSS remains the same ... */
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D; --pill:#e9f6f0;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    body{font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    /* ... rest of your CSS remains unchanged ... */
  </style>
</head>
<body>
  <!-- Your HTML structure remains the same -->
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo">
  </div>

  <h1>QA Evaluations – Monthly View</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <div id="authDebug" class="card" style="display:none">
    <h2 class="section-title">Auth debug</h2>
    <pre id="authDump" style="background:#f6f8fa;border:1px solid #eee;padding:12px;border-radius:8px;overflow:auto"></pre>
    <button id="signinBtn">Sign in with Genesys</button>
  </div>

  <div id="appContent" style="display:none;">
    <!-- Your existing HTML content remains the same -->
  </div>

  <script>
    /* ====== Config ====== */
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const config = { REGION: 'mypurecloud.ie' };
    const DEBUG = new URLSearchParams(window.location.search).has('debug');
    const redirectUri = 'https://gmcglynn88.github.io/QualityReporting/';
    const oauthUrl = `https://login.${config.REGION}/oauth/authorize?client_id=${encodeURIComponent(clientId)}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&state=qa`;

    const state = {
      accessToken: null,
      users: [], forms: [], formsById: {},
      teams: [], teamsById: {}, teamMembers: new Map(),
      evals: [], monthStart:null, monthEnd:null,
      analyticsEvals: null, analyticsRange: null,
      formDetailsCache:new Map(), formLookupCache:new Map(), combinedLookupCache:new Map()
    };
    const dropdowns = { users:null, teams:null, forms:null, analyticsTeams:null };

    /* ====== Utilities ====== */
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    let lastApiCall=0; const API_DELAY=120;
    const MAX_AGENT_IDS_PER_POST = 20;
    const PAGE_SIZE = 100;

    function msg(html,type='info'){ const box=document.getElementById('messageContainer'); box.innerHTML=`<div class="${type}-message">${html}</div>`; box.style.display='block'; if(type==='success'){ setTimeout(()=>box.style.display='none',5000); } }
    function setLoading(button,isLoading){ const s=button.querySelector('.loading-spinner'); const t=button.querySelector('.btn-text'); if(isLoading){ s.style.display='inline-block'; t.textContent='Loading...'; button.disabled=true; } else { s.style.display='none'; t.textContent=(button.id==='loadAnalyticsBtn'?'Load Range':'Load Evaluations'); button.disabled=false; } }
    function toUKDate(d){ const dt=new Date(d); return dt.toLocaleDateString('en-GB'); }
    function pct(n,d=1){ if(n==null||!isFinite(n)) return '-'; return (Math.round(n*10**d)/10**d).toFixed(d)+'%'; }
    function fmt(n,d=1){ if(n==null||!isFinite(n)) return '-'; return (Math.round(n*10**d)/10**d).toFixed(d); }
    function safeGet(o,p,def=null){ try{ return p.split('.').reduce((x,k)=>(x && k in x)?x[k]:undefined ,o) ?? def; }catch{ return def; } }
    function dayKeyUTC(d){ const dt=new Date(d); return new Date(Date.UTC(dt.getUTCFullYear(),dt.getUTCMonth(),dt.getUTCDate())).toISOString().split('T')[0]; }

    function tableSorter(tableId){ const t=document.getElementById(tableId); if(!t||!t.tHead) return; const ths=[...t.tHead.querySelectorAll('th')]; ths.forEach((th,i)=>{ th.onclick=()=>{ const dir=th.dataset.dir==='asc'?'desc':'asc'; ths.forEach(h=>{h.dataset.dir=''; const s=h.querySelector('.sort-ind'); if(s) s.remove();}); th.dataset.dir=dir; const ind=document.createElement('span'); ind.className='sort-ind'; ind.textContent=dir==='asc'?'▲':'▼'; th.appendChild(ind);
          const body=t.tBodies[0]; const rows=[...body.rows]; const num=th.dataset.type==='num'; rows.sort((a,b)=>{ const av=a.cells[i].getAttribute('data-sort') ?? a.cells[i].innerText; const bv=b.cells[i].getAttribute('data-sort') ?? b.cells[i].innerText; const A=num?Number(av):String(av).toLowerCase(); const B=num?Number(bv):String(bv).toLowerCase(); return dir==='asc'? (A>B?1:A<B?-1:0) : (A<B?1:A>B?-1:0); }); body.innerHTML=''; rows.forEach(r=>body.appendChild(r)); }; }); t.classList.add('sortable'); }

    /* ====== RENDER ALL functions - MOVED UP ====== */
    function renderAll(){ 
        renderOverview(); 
        renderAnalytics(); 
        renderDetails(); 
        renderCritical(); 
    }

    function renderOverview(){
      const evals=state.evals;
      const byAgent=new Map();
      evals.forEach(e=>{
        const a=safeGet(e,'agent.id')||e.agentUserId||'(unknown)';
        const p=getEvalPercent(e);
        if(!byAgent.has(a)) byAgent.set(a,{count:0,sum:0});
        const o=byAgent.get(a); o.count++; if(p!=null&&isFinite(p)) o.sum+=Number(p);
      });
      const rows=[]; let total=0;
      for(const [aid,{count,sum}] of byAgent.entries()){
        rows.push({agent:resolveUserName(aid),count,avg:count?(sum/count):null}); total+=count;
      }
      rows.sort((a,b)=>a.agent.localeCompare(b.agent));
      const overallAvg=(rows.length&&total)?(rows.reduce((s,r)=>s+(r.avg||0),0)/rows.length):null;
      document.getElementById('overviewKPIs').innerHTML=`
        <div class="kpi"><div class="label">Month</div><div class="value">${document.getElementById('monthInput').value}</div></div>
        <div class="kpi"><div class="label">Evaluations</div><div class="value">${evals.length}</div></div>
        <div class="kpi"><div class="label">Agents</div><div class="value">${rows.length}</div></div>
        <div class="kpi"><div class="label">Average Score (Agent Avg)</div><div class="value">${overallAvg==null?'-':pct(overallAvg,1)}</div></div>`;
      const tbl=document.getElementById('agentSummaryTable');
      tbl.innerHTML=rows.length?`<thead><tr><th>Agent</th><th>Evaluations</th><th>Average Score</th></tr></thead><tbody>${rows.map(r=>`<tr><td>${r.agent}</td><td>${r.count}</td><td>${r.avg==null?'-':pct(r.avg,1)}</td></tr>`).join('')}</tbody>`:'<tr><td colspan="3" class="muted">No evaluation data available for the selected criteria.</td></tr>';
    }

    function renderAnalytics(){
      // Your existing renderAnalytics function implementation
      console.log('Analytics rendering...');
      // Add your existing renderAnalytics code here
    }

    async function renderDetails(){
      // Your existing renderDetails function implementation
      console.log('Details rendering...');
      // Add your existing renderDetails code here
    }

    async function renderCritical(){
      // Your existing renderCritical function implementation
      console.log('Critical rendering...');
      // Add your existing renderCritical code here
    }

    /* ====== Networking with backoff ====== */
    async function rawFetch(url,options={}){ 
        const now=Date.now(); 
        const delta=now-lastApiCall; 
        if(delta<API_DELAY) await sleep(API_DELAY-delta); 
        lastApiCall=Date.now(); 
        return fetch(url,{
            ...options,
            headers:{
                'Authorization':'Bearer '+state.accessToken,
                'Content-Type':'application/json',
                ...(options.headers||{})
            }
        }); 
    }
    
    async function fetchJsonWithRetry(url, options={}, {retries=6, baseDelay=600}={}){
      let attempt=0;
      while(true){
        const res=await rawFetch(url,options);
        if(res.ok){ return res.status===204?null:await res.json(); }
        const status=res.status;
        if([400,401,403,404,405].includes(status)){ 
            const err=new Error(`HTTP ${status}`); 
            err.status=status; 
            throw err; 
        }
        attempt++; 
        if(attempt>retries){ 
            const err=new Error(`HTTP ${status} after ${retries} retries`); 
            err.status=status; 
            throw err; 
        }
        const ra=Number(res.headers.get('Retry-After'))||null;
        const delay = ra? ra*1000 : Math.round(baseDelay*(2**(attempt-1))*(1+Math.random()*0.25));
        await sleep(delay);
      }
    }

    async function fetchPaginatedGET(url){
      let all=[], next=url;
      while(next){
        const data=await fetchJsonWithRetry(next,{method:'GET'});
        if(Array.isArray(data.entities)) all=all.concat(data.entities);
        else if(Array.isArray(data.users)) all=all.concat(data.users);
        else if(Array.isArray(data)) all=all.concat(data);
        else if(data?.entities) all=all.concat(data.entities);
        next=data?.nextUri?`https://api.${config.REGION}${data.nextUri}`:null;
      }
      return all;
    }

    /* ====== App UI boot ====== */
    document.addEventListener('DOMContentLoaded',()=>{
      const params=new URLSearchParams(window.location.hash.substring(1)); 
      const token=params.get('access_token');
      if(token){ 
          sessionStorage.setItem('purecloud_token',token); 
          history.replaceState(null,document.title,window.location.pathname+window.location.search); 
          startApp(token); 
          return; 
      }
      const tok=sessionStorage.getItem('purecloud_token');
      if(tok){ startApp(tok); return; }
      if(DEBUG){
        document.getElementById('authDebug').style.display='block';
        document.getElementById('authDump').textContent='No token. Click Sign in.';
        document.getElementById('signinBtn').onclick=()=>window.location.href=oauthUrl;
        document.getElementById('auth-message').textContent='Debug mode: click Sign in with Genesys';
      } else {
        document.getElementById('auth-message').textContent='Redirecting to Genesys Cloud for authentication...';
        setTimeout(()=>window.location.href=oauthUrl,1200);
      }
    });

    function startApp(token){
      state.accessToken=token; 
      document.getElementById('auth-message').textContent='Authenticated successfully!'; 
      document.getElementById('auth-message').className='success-message';
      setTimeout(()=>{ 
          document.getElementById('authCard').style.display='none'; 
          document.getElementById('authDebug').style.display='none'; 
      }, 800);
      document.getElementById('appContent').style.display='block';

      // Initialize dropdowns
      dropdowns.users=createCheckboxDropdown('userDropdown',{placeholder:'Select agents (optional)',searchPlaceholder:'Search agents...'});
      dropdowns.teams=createCheckboxDropdown('teamDropdown',{placeholder:'Select work teams (optional)',searchPlaceholder:'Search teams...'});
      dropdowns.forms=createCheckboxDropdown('formDropdown',{placeholder:'Select forms (optional)',searchPlaceholder:'Search forms...'});
      dropdowns.analyticsTeams=createCheckboxDropdown('analyticsTeamDropdown',{placeholder:'Filter teams (optional)',searchPlaceholder:'Search teams...'});

      // Tab handlers
      document.getElementById('overviewTabButton').onclick=()=>setTab('overview');
      document.getElementById('analyticsTabButton').onclick=()=>setTab('analytics');
      document.getElementById('detailsTabButton').onclick=()=>setTab('details');
      document.getElementById('criticalTabButton').onclick=()=>setTab('critical');

      // Button handlers
      document.getElementById('loadBtn').onclick=loadEvaluations;
      document.getElementById('loadAnalyticsBtn').onclick=loadAnalyticsRange;
      document.getElementById('applyAnalyticsFilters').onclick=renderAnalytics;
      document.getElementById('insightsSort').onchange=renderAgentInsights;
      document.getElementById('passTarget').addEventListener('change',renderAnalytics);
      document.getElementById('amberBand').addEventListener('change',renderAnalytics);

      // Set default dates
      const m=new Date(); 
      const cur=`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}`;
      document.getElementById('monthInput').value=cur; 
      document.getElementById('anaFrom').value=cur; 
      document.getElementById('anaTo').value=cur;
      
      updateMonthRange(); 
      document.getElementById('monthInput').addEventListener('change',()=>{ 
          updateMonthRange(); 
          updateLoadButtonState(); 
      });

      // Load initial data
      Promise.all([fetchAllUsers(), fetchAllTeams(), fetchAllForms()])
        .then(()=> updateLoadButtonState())
        .catch(e=>msg('Initial load failed: '+e.message,'error'));
    }

    function setTab(name){
      ['overview','analytics','details','critical'].forEach(n=>{
        document.getElementById(`${n}Tab`).classList.toggle('active', n===name);
        document.getElementById(`${n}TabButton`).classList.toggle('active', n===name);
      });
      if(name==='analytics') renderAnalytics();
    }

    function updateMonthRange(){
      const v=document.getElementById('monthInput').value; if(!v) return;
      const [y,m]=v.split('-').map(Number);
      state.monthStart=new Date(Date.UTC(y,m-1,1,0,0,0));
      state.monthEnd  =new Date(Date.UTC(y,m,0,23,59,59));
    }

    function updateLoadButtonState(){
      const hasMonth=document.getElementById('monthInput').value;
      const hasUsers=dropdowns.users && dropdowns.users.getSelectedValues().length>0;
      const hasTeams=dropdowns.teams && dropdowns.teams.getSelectedValues().length>0;
      const hasForms=dropdowns.forms && dropdowns.forms.getSelectedValues().length>0;
      document.getElementById('loadBtn').disabled=!(hasMonth && (hasUsers || hasTeams || hasForms));
    }

    /* ====== Checkbox dropdown component ====== */
    function createCheckboxDropdown(containerId,{placeholder,searchPlaceholder}){
      const root=document.getElementById(containerId); root.innerHTML='';
      const trigger=document.createElement('div'); trigger.className='cd-trigger'; trigger.innerHTML=`<span class="label">${placeholder}</span><span class="count">0 selected</span>`; root.appendChild(trigger);
      const panel=document.createElement('div'); panel.className='cd-panel'; panel.innerHTML=`
        <div class="cd-header"><input type="text" class="cd-search" placeholder="${searchPlaceholder}" /><div class="cd-actions"><button type="button" data-cd="clear">Clear</button></div></div>
        <div class="cd-selectall"><label><input type="checkbox" data-cd="selectall"/> Select all</label></div>
        <div class="cd-list"></div>
        <div class="cd-footer"><span data-cd="summary">0 selected</span><span>Click outside to close</span></div>`;
      root.appendChild(panel);
      const list=panel.querySelector('.cd-list'), search=panel.querySelector('.cd-search');
      const clearBtn=panel.querySelector('[data-cd="clear"]'), selectAll=panel.querySelector('[data-cd="selectall"]'), summary=panel.querySelector('[data-cd="summary"]');
      let options=[], selected=new Set();
      function render(filter=''){
        const ft=filter.trim().toLowerCase(); list.innerHTML='';
        const filtered=!ft?options:options.filter(o=>(o.label||'').toLowerCase().includes(ft));
        if(!filtered.length){ list.innerHTML=`<div class="cd-item" style="color:#6C757D">No matches</div>`; return; }
        filtered.forEach(o=>{
          const id=`${containerId}__${o.value}`; const row=document.createElement('div'); row.className='cd-item';
          row.innerHTML=`<label for="${id}"><input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value)?'checked':''}/><span>${o.label||o.value}</span></label>`;
          row.querySelector('input').addEventListener('change',(e)=>{ if(e.target.checked) selected.add(o.value); else selected.delete(o.value); updateSummary(); updateSelectAllState(); if(containerId!=='analyticsTeamDropdown') updateLoadButtonState(); });
          list.appendChild(row);
        });
      }
      function updateSummary(){ trigger.querySelector('.count').textContent=`${selected.size} selected`; summary.textContent=`${selected.size} selected`; }
      function updateSelectAllState(){ const total=options.length,count=selected.size; selectAll.indeterminate=count>0&&count<total; selectAll.checked=total>0&&count===total; }
      trigger.addEventListener('click',()=>{ panel.classList.toggle('open'); search.focus(); });
      document.addEventListener('click',(e)=>{ if(!root.contains(e.target)) panel.classList.remove('open'); });
      search.addEventListener('input',()=>render(search.value));
      clearBtn.addEventListener('click',()=>{ selected.clear(); render(search.value); updateSummary(); updateSelectAllState(); if(containerId!=='analyticsTeamDropdown') updateLoadButtonState(); });
      selectAll.addEventListener('change',()=>{ if(selectAll.checked) options.forEach(o=>selected.add(o.value)); else selected.clear(); render(search.value); updateSummary(); if(containerId!=='analyticsTeamDropdown') updateLoadButtonState(); });
      function setOptions(newOptions){ options=newOptions||[]; selected.forEach(v=>{ if(!options.some(o=>o.value===v)) selected.delete(v); }); render(search.value); updateSummary(); updateSelectAllState(); if(containerId!=='analyticsTeamDropdown') updateLoadButtonState(); }
      function getSelectedValues(){ return Array.from(selected); }
      render(''); return { setOptions, getSelectedValues };
    }

    /* ====== Lookup data ====== */
    async function fetchAllUsers(){
      const url=`https://api.${config.REGION}/api/v2/users?pageSize=100`;
      const users=await fetchPaginatedGET(url);
      state.users=users.map(u=>({id:u.id,name:(u.name||`${u.givenName||''} ${u.familyName||''}`).trim(),email:u.email||''})).sort((a,b)=>a.name.localeCompare(b.name));
      dropdowns.users.setOptions(state.users.map(u=>({value:u.id,label:`${u.name}${u.email?` — ${u.email}`:''}`})));
    }

    async function fetchAllTeams(){
      const url=`https://api.${config.REGION}/api/v2/teams?pageSize=100`;
      const teams=await fetchPaginatedGET(url);
      state.teams=teams.map(t=>({id:t.id,name:t.name||'(Unnamed team)'})).sort((a,b)=>a.name.localeCompare(b.name));
      state.teamsById=Object.fromEntries(state.teams.map(t=>[t.id,t]));
      dropdowns.teams.setOptions(state.teams.map(t=>({value:t.id,label:t.name})));
      dropdowns.analyticsTeams.setOptions(state.teams.map(t=>({value:t.id,label:t.name})));
    }

    async function ensureTeamMembersLoaded(ids){ const missing=ids.filter(id=>!state.teamMembers.has(id)); if(!missing.length) return; await Promise.all(missing.map(fetchTeamMembers)); }
    async function fetchTeamMembers(teamId){
      const url=`https://api.${config.REGION}/api/v2/teams/${teamId}/members?pageSize=100`;
      const members=await fetchPaginatedGET(url);
      const ids=Array.from(new Set(members.map(m=>safeGet(m,'member.id')||safeGet(m,'member.user.id')||safeGet(m,'user.id')||safeGet(m,'id')).filter(Boolean)));
      state.teamMembers.set(teamId,ids);
    }

    async function fetchAllForms(){
      const url=`https://api.${config.REGION}/api/v2/quality/forms/evaluations?pageSize=100`;
      const forms=await fetchPaginatedGET(url);
      state.forms=forms.map(f=>({id:f.id,name:f.name||f.title||'(Unnamed form)'})).sort((a,b)=>a.name.localeCompare(b.name));
      state.formsById=Object.fromEntries(state.forms.map(f=>[f.id,f]));
      dropdowns.forms.setOptions(state.forms.map(f=>({value:f.id,label:f.name})));
    }

    async function computeSelectedAgentIds(){
      const u=dropdowns.users.getSelectedValues(); const t=dropdowns.teams.getSelectedValues(); const set=new Set(u);
      if(t.length){ await ensureTeamMembersLoaded(t); t.forEach(tid=>(state.teamMembers.get(tid)||[]).forEach(id=>set.add(id))); }
      return Array.from(set);
    }

    /* ====== Forms + text lookup ====== */
    function formKey(formId,versionId){ return (versionId==='__published__')?`pub@${formId}`:`${formId}@${versionId||'latest'}`; }

    async function getFormDetails(formId,versionId){
      const key=formKey(formId,versionId);
      if(state.formDetailsCache.has(key)) return state.formDetailsCache.get(key);
      let url;
      if(versionId==='__published__') url=`https://api.${config.REGION}/api/v2/quality/publishedforms/evaluations/${formId}`;
      else url=versionId?`https://api.${config.REGION}/api/v2/quality/forms/evaluations/${formId}/versions/${versionId}`:`https://api.${config.REGION}/api/v2/quality/forms/evaluations/${formId}`;
      try{
        let data;
        try{ data=await fetchJsonWithRetry(url,{method:'GET'}); }
        catch(err){ if(versionId&&versionId!=='__published__'){ data=await fetchJsonWithRetry(`https://api.${config.REGION}/api/v2/quality/forms/evaluations/${formId}`,{method:'GET'}); } else throw err; }
        state.formDetailsCache.set(key,data);
        state.formLookupCache.set(key,buildFormLookup(data||{}));
        return data;
      }catch(e){ state.formDetailsCache.set(key,null); return null; }
    }

    function buildFormLookup(form){
      const questionText=new Map(), answerText=new Map(), questionObj=new Map();
      function addQ(q){
        if(!q) return;
        const qTxt=q.text||q.label||q.title||'';
        [q.id,q.contextId,q.questionId,q.questionContextId].filter(Boolean).forEach(id=>{questionText.set(id,qTxt);questionObj.set(id,q);});
        (q.answerOptions||[]).forEach(a=>{
          const aTxt=a.text??String(a.value??'');
          [a.id,a.contextId,a.answerId,a.answerOptionId].filter(Boolean).forEach(id=>answerText.set(id,aTxt));
        });
        (q.multipleSelectOptionQuestions||[]).forEach(addQ);
      }
      function walk(groups){ (groups||[]).forEach(g=>{ (g.questions||[]).forEach(addQ); (g.questionGroups||[]).forEach(walk); }); }
      (form?.questions||[]).forEach(addQ); walk(form?.questionGroups);
      return {questionText,answerText,questionObj};
    }

    async function getCombinedLookupForEval(e){
      const pubId=safeGet(e,'evaluationForm.id');
      const formId=safeGet(e,'form.id')||e.formId;
      const formVersionId=safeGet(e,'form.versionId')||e.formVersionId||safeGet(e,'form.version');
      const comboKey=[pubId?`pub:${pubId}`:'',formId?`form:${formId}`:'',formVersionId?`ver:${formVersionId}`:''].filter(Boolean).join('|')||'none';
      if(state.combinedLookupCache.has(comboKey)) return state.combinedLookupCache.get(comboKey);
      const details=(await Promise.all([
        pubId?getFormDetails(pubId,'__published__'):null,
        formId&&formVersionId?getFormDetails(formId,formVersionId):null,
        formId&&!formVersionId?getFormDetails(formId,null):null
      ])).filter(Boolean);
      const merged={questionText:new Map(),answerText:new Map(),questionObj:new Map()};
      const names=[];
      details.forEach(d=>{
        if(d?.name) names.push(d.name);
        const lk=buildFormLookup(d||{});
        lk.questionText.forEach((v,k)=>merged.questionText.set(k,v));
        lk.answerText.forEach((v,k)=>merged.answerText.set(k,v));
        lk.questionObj.forEach((v,k)=>merged.questionObj.set(k,v));
      });
      const formName=safeGet(e,'evaluationForm.name')||safeGet(e,'form.name')||names[0]||'(Form)';
      const combined={...merged, formName};
      state.combinedLookupCache.set(comboKey,combined);
      return combined;
    }

    function resolveQuestionTextWithLookup(lookup,qScore){
      const ids=[qScore.questionId,qScore.questionContextId,safeGet(qScore,'question.id'),safeGet(qScore,'question.contextId')].filter(Boolean);
      for(const id of ids){ const t=lookup.questionText.get(id); if(t) return t; }
      return safeGet(qScore,'question.text') || `Question ${ids[0]||''}`.trim();
    }

    function approx(a,b){ return Math.abs(Number(a)-Number(b))<1e-6; }

    /* ====== Core metrics/render helpers ====== */
    function getEvalPercent(e){
      const p=e.totalScore||e.totalPercent||safeGet(e,'scoring.totalPercent')||safeGet(e,'oTotalPercent')||safeGet(e,'answers.totalScore');
      if(p==null) return null; return p<=1? p*100 : p;
    }
    function resolveUserName(id){ const u=state.users.find(x=>x.id===id); return u?u.name:(id||'(unknown)'); }
    function standardiseMedia(m){ const x=String(m||'').toUpperCase(); if(x.includes('EMAIL')) return 'Email'; if(x.includes('CALL')||x.includes('VOICE')||x==='CALL') return 'Voice'; if(x.includes('CHAT')||x.includes('MESSAGE')) return 'Message'; if(x.includes('SOCIAL')) return 'Social'; return 'Other'; }
    function guessMediaType(e){ return standardiseMedia(safeGet(e,'mediaType') || safeGet(e,'conversation.mediaType') || 'Other'); }
    function getPassSettings(){ const pass=parseFloat(document.getElementById('passTarget').value||'85'); const band=parseFloat(document.getElementById('amberBand').value||'5'); return {pass, band}; }
    function colourFor(score, pass, band){ if(score==null||!isFinite(score)) return 'var(--bad)'; if(score>=pass) return 'var(--ok)'; if(score>=pass-band) return 'var(--warn)'; return 'var(--bad)'; }

    /* ====== Load / query evaluations (POST-only) ====== */
    async function postEvalQuery(agentIds, formIds, startDate, endDate){
      // FIXED: Use the correct API endpoint for evaluations query
      const url=`https://api.${config.REGION}/api/v2/quality/evaluations/query`;
      const start=startDate.toISOString(), end=endDate.toISOString();
      let page=1, all=[];
      while(true){
        const body={ 
            agentUserIds: agentIds, 
            interval: `${start}/${end}`,
            expand: ['answerTotalScores', 'evaluationForm'],
            pageSize: PAGE_SIZE, 
            pageNumber: page 
        };
        if(formIds && formIds.length) body.formIds=formIds;
        
        try {
            const data=await fetchJsonWithRetry(url,{
                method:'POST', 
                body:JSON.stringify(body)
            });
            const ents=data?.entities||[];
            if(!ents.length){ break; }
            all=all.concat(ents);
            if(!data.nextUri && ents.length < PAGE_SIZE){ break; }
            page++;
        } catch (error) {
            console.error('Error fetching evaluations:', error);
            throw error;
        }
      }
      return all;
    }

    async function fetchDetailedEvaluations(allAgentIds, formIds, startDate, endDate){
      const results=[];
      for(let i=0;i<allAgentIds.length;i+=MAX_AGENT_IDS_PER_POST){
        const chunk=allAgentIds.slice(i,i+MAX_AGENT_IDS_PER_POST);
        const part=await postEvalQuery(chunk, formIds, startDate, endDate);
        results.push(...part);
        if(i+MAX_AGENT_IDS_PER_POST<allAgentIds.length) await sleep(300);
      }
      return results;
    }

    async function loadEvaluations(){
      const agentIds=await computeSelectedAgentIds(); 
      const formIds=dropdowns.forms.getSelectedValues();
      if(agentIds.length===0 && formIds.length===0){ 
          msg('Please select at least one agent, team, or form.','error'); 
          return; 
      }
      if(!state.monthStart||!state.monthEnd){ 
          msg('Please select a month.','error'); 
          return; 
      }
      const btn=document.getElementById('loadBtn'); 
      setLoading(btn,true); 
      msg('Loading evaluations…','info');
      try{
        const list=agentIds.length?agentIds:state.users.map(u=>u.id);
        state.evals=await fetchDetailedEvaluations(list, formIds, state.monthStart, state.monthEnd);
        msg(`Loaded ${state.evals.length} evaluations.`,'success');
        renderAll(); // This should now work since renderAll is defined
      }catch(e){ 
          console.error(e); 
          msg('Failed to load evaluations: '+e.message,'error'); 
      }
      finally{ setLoading(btn,false); }
    }

    async function loadAnalyticsRange(){
      const from=document.getElementById('anaFrom').value, to=document.getElementById('anaTo').value; 
      if(!from||!to){ 
          msg('Select both From and To months for Analytics.','error'); 
          return; 
      }
      const [fy,fm]=from.split('-').map(Number); 
      const [ty,tm]=to.split('-').map(Number);
      const start=new Date(Date.UTC(fy,fm-1,1,0,0,0)); 
      const end=new Date(Date.UTC(ty,tm,0,23,59,59)); 
      if(start>end){ 
          msg('The From month must be before the To month.','error'); 
          return; 
      }
      const formIds=dropdowns.forms.getSelectedValues(); 
      const agentIds=await computeSelectedAgentIds(); 
      if(agentIds.length===0 && formIds.length===0){ 
          msg('Please select at least one agent, team, or form.','error'); 
          return; 
      }
      const btn=document.getElementById('loadAnalyticsBtn'); 
      setLoading(btn,true);
      try{
        const list=agentIds.length?agentIds:state.users.map(u=>u.id);
        const data=await fetchDetailedEvaluations(list, formIds, start, end);
        state.analyticsEvals=data; 
        state.analyticsRange={start,end};
        msg(`Analytics range loaded: ${data.length} evaluations.`,'success');
        renderAnalytics();
      }catch(e){ 
          console.error(e); 
          msg('Failed to load analytics range: '+e.message,'error'); 
      }
      finally{ setLoading(btn,false); }
    }

    // Add any missing functions that were in your original code but might be missing
    function renderAgentInsights() {
        // Add your renderAgentInsights implementation
    }

    // Add other missing functions as needed...

  </script>
</body>
</html>
